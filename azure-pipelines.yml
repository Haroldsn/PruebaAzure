trigger:
  branches:
    include:
      - main  

variables:
  PYTHON_VERSION: '3.9'
  ARTIFACT_NAME: 'HaroldSneiderOrosteguiAlfonso-$(Build.BuildId).zip'
  AWS_REGION: 'us-east-1'
  SERVICE_CONNECTION: 'AWS'

stages:
- stage: Build
  displayName: "Stage 1 - IntegraciÃ³n Continua"
  jobs:
    - job: BuildJob
      displayName: "Compilar y Empaquetar"
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '$(PYTHON_VERSION)'
        
        - script: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            python -m unittest discover
          displayName: "Instalar dependencias y ejecutar pruebas"

        - task: ArchiveFiles@2
          displayName: "Crear paquete ZIP"
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(ARTIFACT_NAME)'
            replaceExistingArchive: true

        - task: PublishBuildArtifacts@1
          displayName: "Publicar Artefacto"
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/$(ARTIFACT_NAME)'
            ArtifactName: 'drop'
            publishLocation: 'Container'

- stage: Deploy
  displayName: "Stage 2 - Despliegue AWS"
  dependsOn: Build
  jobs:
    - deployment: DeployJob
      displayName: "Desplegar en AWS"
      environment: "aws-deployment"
      pool:
        vmImage: 'ubuntu-latest'
      strategy:
        runOnce: 
          deploy:
            steps:
              - task: AWSCLI@1
                displayName: 'Subir ZIP a S3'
                inputs:
                  awsCredentials: '$(SERVICE_CONNECTION)'
                  regionName: '$(AWS_REGION)'
                  awsCommand: 's3'
                  awsSubCommand: 'cp'
                  awsArguments: '$(Pipeline.Workspace)/drop/$(ARTIFACT_NAME) s3://pruebas-devops1/$(ARTIFACT_NAME)'

              - task: AWSCLI@1
                displayName: 'Crear Application Version'
                inputs:
                  awsCredentials: '$(SERVICE_CONNECTION)'
                  regionName: '$(AWS_REGION)'
                  awsCommand: 'elasticbeanstalk'
                  awsSubCommand: 'create-application-version'
                  awsArguments: >
                    --application-name Pruebas
                    --version-label build-$(Build.BuildId)
                    --source-bundle S3Bucket=pruebas-devops1,S3Key=$(ARTIFACT_NAME)

              - task: AWSCLI@1
                displayName: 'Actualizar Environment'
                inputs:
                  awsCredentials: '$(SERVICE_CONNECTION)'
                  regionName: '$(AWS_REGION)'
                  awsCommand: 'elasticbeanstalk'
                  awsSubCommand: 'update-environment'
                  awsArguments: >
                    --environment-name Pruebas-env-2
                    --version-label build-$(Build.BuildId)
